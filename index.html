async function fetchData() {
  const response = await fetch(sheetUrl);
  const data = await response.text();
  const rows = data.split("\n").slice(1); // bỏ dòng tiêu đề

  let tableBody = "";
  const labels = [];
  const temps = [];
  const hums = [];

  rows.forEach(row => {
    const cols = row.split(",");
    if (cols.length >= 3) {
      const time = cols[0];
      const temp = parseFloat(cols[1]);
      const hum = parseFloat(cols[2]);

      tableBody += `<tr><td>${time}</td><td>${temp}</td><td>${hum}</td></tr>`;
      labels.push(time);
      temps.push(temp);
      hums.push(hum);
    }
  });

  document.querySelector("#dataTable tbody").innerHTML = tableBody;

  // Giới hạn chỉ lấy 100 giá trị cuối
  const maxPoints = 100;
  const slicedLabels = labels.slice(-maxPoints);
  const slicedTemps = temps.slice(-maxPoints);
  const slicedHums = hums.slice(-maxPoints);

  // Cập nhật giá trị mới nhất (dòng cuối cùng)
  if (labels.length > 0) {
    document.getElementById("latestTime").textContent = labels[labels.length - 1];
    document.getElementById("latestTemp").textContent = temps[temps.length - 1];
    document.getElementById("latestHum").textContent = hums[labels.length - 1];
  }

  // Vẽ biểu đồ
  const ctx = document.getElementById("myChart").getContext("2d");
  new Chart(ctx, {
    type: "line",
    data: {
      labels: slicedLabels,
      datasets: [
        {
          label: "Nhiệt độ (°C)",
          data: slicedTemps,
          borderColor: "red",
          fill: false
        },
        {
          label: "Độ ẩm (%)",
          data: slicedHums,
          borderColor: "blue",
          fill: false
        }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}
